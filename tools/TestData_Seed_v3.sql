-- =====================================================
-- TEST DATA SCRIPT - Resource Management Tool
-- Version: 3.0 (UPDATED & VALIDATED)
-- Date: 2026-02-03
-- Purpose: Comprehensive test data for all test cases including Snapshot workflow
-- =====================================================
-- IMPORTANT NOTES:
-- - Username/PasswordHash/Role fields DO NOT exist in current Roster table
-- - RBAC authentication is NOT yet implemented (placeholder only)
-- - This script creates test data for when RBAC is implemented
-- - Snapshot data will be auto-generated by SnapshotRecalculationService
-- =====================================================

-- =====================================================
-- CLEANUP (Optional - uncomment to reset)
-- =====================================================
/*
DELETE FROM ProjectMonthlySnapshot;
DELETE FROM ResourceAllocation;
DELETE FROM ForecastVersion;
DELETE FROM Billing;
DELETE FROM Expense;
DELETE FROM ProjectRate;
DELETE FROM [Override];
DELETE FROM Project WHERE Name LIKE 'TEST_%';
DELETE FROM GlobalRate;
DELETE FROM Roster WHERE SapCode LIKE 'TEST_%';
*/

-- =====================================================
-- 1. GLOBAL RATES (Epic 4, Test 3.2.1, Test 4.1.x)
-- =====================================================
PRINT 'Setting up Global Rates...';

-- Delete existing test rates to avoid conflicts
DELETE FROM GlobalRate WHERE Level IN ('A', 'BA', 'C', 'SC', 'M', 'SM', 'D', 'P');

INSERT INTO GlobalRate (Level, NominalRate) VALUES 
    ('BA', 250.00),     -- Business Analyst
    ('A', 300.00),      -- Associate
    ('C', 400.00),      -- Consultant
    ('SC', 500.00),     -- Senior Consultant (for Test 3.2.1: WIP = 10 * 500 * 0.9 = 4500)
    ('M', 800.00),      -- Manager (for Test 4.1.1, 4.1.2)
    ('SM', 900.00),     -- Senior Manager
    ('D', 1200.00),     -- Director
    ('P', 1500.00);     -- Partner

PRINT 'Global Rates created: ' + CAST(@@ROWCOUNT AS VARCHAR(10));

-- =====================================================
-- 2. ROSTER MEMBERS (Epic 1, Epic 5 - FUTURE)
-- =====================================================
PRINT 'Setting up Roster Members...';

-- Clear test users
DELETE FROM Roster WHERE SapCode LIKE 'TEST_%';

-- IMPORTANT: Username, PasswordHash, Role columns DO NOT EXIST
-- These are commented out for future when RBAC is implemented

-- Test User 1: Future ADMIN Role
INSERT INTO Roster (SapCode, FullNameEn, LegalEntity, FunctionBusinessUnit, CostCenterCode, Level, 
    MonthlySalary, MonthlyEmployerContributions, Cars, TicketRestaurant, Metlife)
VALUES 
    ('TEST_ADMIN_001', 'Admin User', 'Deloitte Greece', 'Operations', 'CC001', 'D',
     8000.00, 1500.00, 500.00, 150.00, 100.00);
     -- Future: Username='admin', Password='admin123', Role='Admin'

-- Test User 2: Future PARTNER Role
INSERT INTO Roster (SapCode, FullNameEn, LegalEntity, FunctionBusinessUnit, CostCenterCode, Level, 
    MonthlySalary, MonthlyEmployerContributions, Cars, TicketRestaurant, Metlife)
VALUES 
    ('TEST_PARTNER_001', 'Partner User', 'Deloitte Greece', 'Operations', 'CC002', 'P',
     12000.00, 2500.00, 800.00, 150.00, 150.00);
     -- Future: Username='partner', Password='admin123', Role='Partner'

-- Test User 3: Future MANAGER Role (for Test 5.4.x)
INSERT INTO Roster (SapCode, FullNameEn, LegalEntity, FunctionBusinessUnit, CostCenterCode, Level, 
    MonthlySalary, MonthlyEmployerContributions, Cars, TicketRestaurant, Metlife)
VALUES 
    ('TEST_MANAGER_001', 'Manager User', 'Deloitte Greece', 'Engineering', 'CC100', 'M',
     6000.00, 1200.00, 400.00, 150.00, 80.00);
     -- Future: Username='manager', Password='admin123', Role='Manager'

-- Test User 4: Future EMPLOYEE Role (for Test 5.3.x)
INSERT INTO Roster (SapCode, FullNameEn, LegalEntity, FunctionBusinessUnit, CostCenterCode, Level, 
    MonthlySalary, MonthlyEmployerContributions, Cars, TicketRestaurant, Metlife)
VALUES 
    ('TEST_EMP_001', 'Employee User', 'Deloitte Greece', 'Engineering', 'CC101', 'SC',
     4000.00, 800.00, 0.00, 150.00, 50.00);
     -- Future: Username='employee', Password='admin123', Role='Employee'

-- Test User 5: "John Smith" for search test (Test 1.3.1)
INSERT INTO Roster (SapCode, FullNameEn, LegalEntity, FunctionBusinessUnit, CostCenterCode, Level, 
    MonthlySalary, MonthlyEmployerContributions, Cars, TicketRestaurant, Metlife)
VALUES 
    ('TEST_JOHN_001', 'John Smith', 'Deloitte Greece', 'Engineering', 'CC102', 'SC',
     4500.00, 900.00, 200.00, 150.00, 60.00);

-- Test Users 6-8: More SC members for filter test (Test 1.3.2)
INSERT INTO Roster (SapCode, FullNameEn, LegalEntity, FunctionBusinessUnit, CostCenterCode, Level, 
    MonthlySalary, MonthlyEmployerContributions, Cars, TicketRestaurant, Metlife)
VALUES 
    ('TEST_SC_001', 'Maria Garcia', 'Deloitte Greece', 'AI & Data', 'CC103', 'SC',
     4200.00, 850.00, 0.00, 150.00, 55.00),
    ('TEST_SC_002', 'Andreas Papadopoulos', 'Deloitte Greece', 'Engineering', 'CC104', 'SC',
     4300.00, 870.00, 150.00, 150.00, 58.00),
    ('TEST_C_001', 'Elena Konstantinou', 'Deloitte Greece', 'Operations', 'CC200', 'C',
     3000.00, 600.00, 0.00, 150.00, 40.00),
    ('TEST_M_001', 'Nikos Georgiou', 'Deloitte Greece', 'Engineering', 'CC105', 'M',
     5500.00, 1100.00, 350.00, 150.00, 75.00),
    ('TEST_BA_001', 'Sofia Dimitriou', 'Deloitte Greece', 'Consulting', 'CC201', 'BA',
     2500.00, 500.00, 0.00, 150.00, 30.00);

PRINT 'Roster Members created: ' + CAST(@@ROWCOUNT AS VARCHAR(10));

-- =====================================================
-- 3. PROJECTS (Epic 2, Epic 3, Epic 8)
-- =====================================================
PRINT 'Setting up Projects...';

DECLARE @ManagerRosterId INT = (SELECT Id FROM Roster WHERE SapCode = 'TEST_MANAGER_001');
DECLARE @EmployeeRosterId INT = (SELECT Id FROM Roster WHERE SapCode = 'TEST_EMP_001');
DECLARE @JohnRosterId INT = (SELECT Id FROM Roster WHERE SapCode = 'TEST_JOHN_001');
DECLARE @MariaRosterId INT = (SELECT Id FROM Roster WHERE SapCode = 'TEST_SC_001');
DECLARE @SofiaRosterId INT = (SELECT Id FROM Roster WHERE SapCode = 'TEST_BA_001');

-- Delete test projects to avoid conflicts
DELETE FROM Project WHERE Wbs LIKE 'TEST.%';

-- Project 1: For Test 2.1.1 (100k budget, 20% discount = 125k nominal)
INSERT INTO Project (Name, Wbs, StartDate, EndDate, ActualBudget, NominalBudget, Discount, Recoverability, TargetMargin)
VALUES ('TEST_Budget Calculation Project', 'TEST.001', '2026-01-01', '2026-12-31', 
        100000.00, 125000.00, 20.00, 95.00, 20.00);

-- Project 2: For WIP Calculation Test (Test 3.2.1 - 10% discount)
INSERT INTO Project (Name, Wbs, StartDate, EndDate, ActualBudget, NominalBudget, Discount, Recoverability, TargetMargin)
VALUES ('TEST_WIP Calculation Project', 'TEST.002', '2026-01-01', '2026-06-30', 
        50000.00, 55555.56, 10.00, 90.00, 25.00);

-- Project 3: Snapshot Workflow Test Project (Epic 8 - NEW)
-- This project has 6 months to test Pending -> Editable -> Confirmed workflow
INSERT INTO Project (Name, Wbs, StartDate, EndDate, ActualBudget, NominalBudget, Discount, Recoverability, TargetMargin)
VALUES ('TEST_Snapshot Workflow Project', 'TEST.003', '2026-01-01', '2026-06-30', 
        300000.00, 333333.33, 10.00, 92.00, 30.00);

-- Project 4: For Manager Assignment Test (Test 5.4.2 - FUTURE)
INSERT INTO Project (Name, Wbs, StartDate, EndDate, ActualBudget, NominalBudget, Discount, Recoverability, TargetMargin)
VALUES ('TEST_Manager Assigned Project', 'TEST.004', '2026-01-01', '2026-12-31', 
        200000.00, 222222.22, 10.00, 92.00, 22.00);

-- Project 5: NOT assigned to Manager (Test 5.4.3 - FUTURE)
INSERT INTO Project (Name, Wbs, StartDate, EndDate, ActualBudget, NominalBudget, Discount, Recoverability, TargetMargin)
VALUES ('TEST_Unassigned Project', 'TEST.005', '2026-02-01', '2026-10-31', 
        75000.00, 78947.37, 5.00, 88.00, 18.00);

-- Project 6: Assigned to Employee (Test 5.3.1 - FUTURE)
INSERT INTO Project (Name, Wbs, StartDate, EndDate, ActualBudget, NominalBudget, Discount, Recoverability, TargetMargin)
VALUES ('TEST_Employee Assigned Project', 'TEST.006', '2026-01-01', '2026-09-30', 
        120000.00, 126315.79, 5.00, 91.00, 21.00);

PRINT 'Projects created: 6';

-- =====================================================
-- 4. FORECAST VERSIONS & ALLOCATIONS
-- =====================================================
PRINT 'Setting up Forecast Versions and Allocations...';

DECLARE @Project2Id INT = (SELECT Id FROM Project WHERE Wbs = 'TEST.002');
DECLARE @Project3Id INT = (SELECT Id FROM Project WHERE Wbs = 'TEST.003');
DECLARE @Project4Id INT = (SELECT Id FROM Project WHERE Wbs = 'TEST.004');
DECLARE @Project6Id INT = (SELECT Id FROM Project WHERE Wbs = 'TEST.006');

-- Create Forecast Versions
INSERT INTO ForecastVersion (ProjectId, VersionNumber) VALUES (@Project2Id, 1);
INSERT INTO ForecastVersion (ProjectId, VersionNumber) VALUES (@Project3Id, 1);
INSERT INTO ForecastVersion (ProjectId, VersionNumber) VALUES (@Project4Id, 1);
INSERT INTO ForecastVersion (ProjectId, VersionNumber) VALUES (@Project6Id, 1);

DECLARE @Version2Id INT = (SELECT Id FROM ForecastVersion WHERE ProjectId = @Project2Id AND VersionNumber = 1);
DECLARE @Version3Id INT = (SELECT Id FROM ForecastVersion WHERE ProjectId = @Project3Id AND VersionNumber = 1);
DECLARE @Version4Id INT = (SELECT Id FROM ForecastVersion WHERE ProjectId = @Project4Id AND VersionNumber = 1);
DECLARE @Version6Id INT = (SELECT Id FROM ForecastVersion WHERE ProjectId = @Project6Id AND VersionNumber = 1);

-- Allocations for WIP Test (Test 3.2.1): John (SC) allocated 10 days in Jan 2026
-- Expected WIP = 10 * 500 (SC rate) * 0.9 (10% discount) = 4500
INSERT INTO ResourceAllocation (ForecastVersionId, RosterId, Month, AllocatedDays)
VALUES (@Version2Id, @JohnRosterId, '2026-01-01', 10.00);

-- Allocations for Snapshot Workflow Test (Project 3 - 6 months)
-- January 2026
INSERT INTO ResourceAllocation (ForecastVersionId, RosterId, Month, AllocatedDays) VALUES
    (@Version3Id, @JohnRosterId, '2026-01-01', 18.00),
    (@Version3Id, @MariaRosterId, '2026-01-01', 20.00),
    (@Version3Id, @SofiaRosterId, '2026-01-01', 22.00);

-- February 2026
INSERT INTO ResourceAllocation (ForecastVersionId, RosterId, Month, AllocatedDays) VALUES
    (@Version3Id, @JohnRosterId, '2026-02-01', 20.00),
    (@Version3Id, @MariaRosterId, '2026-02-01', 20.00),
    (@Version3Id, @SofiaRosterId, '2026-02-01', 22.00);

-- March 2026
INSERT INTO ResourceAllocation (ForecastVersionId, RosterId, Month, AllocatedDays) VALUES
    (@Version3Id, @JohnRosterId, '2026-03-01', 22.00),
    (@Version3Id, @MariaRosterId, '2026-03-01', 18.00),
    (@Version3Id, @SofiaRosterId, '2026-03-01', 20.00);

-- April 2026
INSERT INTO ResourceAllocation (ForecastVersionId, RosterId, Month, AllocatedDays) VALUES
    (@Version3Id, @JohnRosterId, '2026-04-01', 20.00),
    (@Version3Id, @MariaRosterId, '2026-04-01', 20.00),
    (@Version3Id, @SofiaRosterId, '2026-04-01', 18.00);

-- May 2026
INSERT INTO ResourceAllocation (ForecastVersionId, RosterId, Month, AllocatedDays) VALUES
    (@Version3Id, @JohnRosterId, '2026-05-01', 15.00),
    (@Version3Id, @MariaRosterId, '2026-05-01', 18.00),
    (@Version3Id, @SofiaRosterId, '2026-05-01', 15.00);

-- June 2026
INSERT INTO ResourceAllocation (ForecastVersionId, RosterId, Month, AllocatedDays) VALUES
    (@Version3Id, @JohnRosterId, '2026-06-01', 10.00),
    (@Version3Id, @MariaRosterId, '2026-06-01', 12.00),
    (@Version3Id, @SofiaRosterId, '2026-06-01', 10.00);

-- Allocate Manager to Project 4 (for future RBAC test 5.4.2)
INSERT INTO ResourceAllocation (ForecastVersionId, RosterId, Month, AllocatedDays)
VALUES (@Version4Id, @ManagerRosterId, '2026-01-01', 15.00);

-- Allocate Employee to Project 6 (for future RBAC test 5.3.1)
INSERT INTO ResourceAllocation (ForecastVersionId, RosterId, Month, AllocatedDays)
VALUES (@Version6Id, @EmployeeRosterId, '2026-01-01', 12.00);

PRINT 'Resource Allocations created: ' + CAST(@@ROWCOUNT AS VARCHAR(10));

-- =====================================================
-- 5. BILLINGS & EXPENSES (Epic 3)
-- =====================================================
PRINT 'Setting up Billings and Expenses...';

-- Project 3 Billings (Snapshot Workflow Test)
INSERT INTO Billing (ProjectId, Month, Amount) VALUES 
    (@Project3Id, '2026-01-01', 45000.00),
    (@Project3Id, '2026-02-01', 50000.00),
    (@Project3Id, '2026-03-01', 48000.00),
    (@Project3Id, '2026-04-01', 52000.00),
    (@Project3Id, '2026-05-01', 40000.00),
    (@Project3Id, '2026-06-01', 30000.00);

-- Project 3 Expenses
INSERT INTO Expense (ProjectId, Month, Amount) VALUES 
    (@Project3Id, '2026-01-01', 2500.00),
    (@Project3Id, '2026-02-01', 3000.00),
    (@Project3Id, '2026-03-01', 2800.00),
    (@Project3Id, '2026-04-01', 2200.00),
    (@Project3Id, '2026-05-01', 1800.00),
    (@Project3Id, '2026-06-01', 1500.00);

-- Project 4 Billings (Manager test)
INSERT INTO Billing (ProjectId, Month, Amount) VALUES (@Project4Id, '2026-01-01', 15000.00);
INSERT INTO Expense (ProjectId, Month, Amount) VALUES (@Project4Id, '2026-01-01', 2500.00);

PRINT 'Billings and Expenses created.';

-- =====================================================
-- 6. PROJECT RATES (Epic 4.2 - Project-Specific Overrides)
-- =====================================================
PRINT 'Setting up Project-Specific Rates...';

-- Project 3 has custom rate for SC level (550 instead of 500)
INSERT INTO ProjectRate (ProjectId, Level, NominalRate, ActualDailyRate)
VALUES (@Project3Id, 'SC', 550.00, 495.00); -- 550 with 10% project discount

PRINT 'Project Rates created.';

-- =====================================================
-- 7. VERIFICATION QUERIES
-- =====================================================
PRINT '';
PRINT '=====================================================';
PRINT 'TEST DATA SUMMARY';
PRINT '=====================================================';

SELECT 'Global Rates' AS Entity, COUNT(*) AS Count FROM GlobalRate;
SELECT 'Roster Members (Test)' AS Entity, COUNT(*) AS Count FROM Roster WHERE SapCode LIKE 'TEST_%';
SELECT 'Projects (Test)' AS Entity, COUNT(*) AS Count FROM Project WHERE Wbs LIKE 'TEST.%';
SELECT 'Forecast Versions' AS Entity, COUNT(*) AS Count FROM ForecastVersion WHERE ProjectId IN (SELECT Id FROM Project WHERE Wbs LIKE 'TEST.%');
SELECT 'Resource Allocations' AS Entity, COUNT(*) AS Count FROM ResourceAllocation WHERE ForecastVersionId IN (SELECT Id FROM ForecastVersion WHERE ProjectId IN (SELECT Id FROM Project WHERE Wbs LIKE 'TEST.%'));
SELECT 'Billings' AS Entity, COUNT(*) AS Count FROM Billing WHERE ProjectId IN (SELECT Id FROM Project WHERE Wbs LIKE 'TEST.%');
SELECT 'Expenses' AS Entity, COUNT(*) AS Count FROM Expense WHERE ProjectId IN (SELECT Id FROM Project WHERE Wbs LIKE 'TEST.%');
SELECT 'Project Rates' AS Entity, COUNT(*) AS Count FROM ProjectRate WHERE ProjectId IN (SELECT Id FROM Project WHERE Wbs LIKE 'TEST.%');

PRINT '';
PRINT '=====================================================';
PRINT 'SNAPSHOT STATUS (after SnapshotRecalculationService runs)';
PRINT '=====================================================';
PRINT 'NOTE: Snapshots are auto-generated when you:';
PRINT '  1. Load Project Overview page';
PRINT '  2. Save allocations/billings/expenses';
PRINT '  3. Perform override/confirm operations';
PRINT '';
PRINT 'Expected for Project TEST.003:';
PRINT '  - 6 months of snapshots (Jan-Jun 2026)';
PRINT '  - January: Status = Editable (1)';
PRINT '  - Feb-Jun: Status = Pending (0)';
PRINT '  - All should have IsOverridden = 0 initially';

SELECT 
    p.Name AS ProjectName,
    pms.Month,
    CASE pms.Status 
        WHEN 0 THEN 'Pending'
        WHEN 1 THEN 'Editable'
        WHEN 2 THEN 'Confirmed'
    END AS Status,
    pms.Wip,
    pms.OperationalCost,
    pms.Nsr,
    pms.Margin,
    pms.IsOverridden
FROM ProjectMonthlySnapshot pms
JOIN Project p ON pms.ProjectId = p.Id
WHERE p.Wbs LIKE 'TEST.%'
ORDER BY p.Name, pms.Month;

PRINT '';
PRINT '=====================================================';
PRINT 'FUTURE RBAC TEST USERS (when authentication implemented)';
PRINT '=====================================================';
PRINT 'All test users will have password: admin123 (BCrypt hashed)';
PRINT '';

SELECT 
    SapCode,
    FullNameEn,
    Level,
    'admin123' AS PlannedPassword,
    CASE 
        WHEN SapCode LIKE '%ADMIN%' THEN 'Admin'
        WHEN SapCode LIKE '%PARTNER%' THEN 'Partner'
        WHEN SapCode LIKE '%MANAGER%' THEN 'Manager'
        ELSE 'Employee'
    END AS PlannedRole
FROM Roster 
WHERE SapCode LIKE 'TEST_%' 
  AND (SapCode LIKE '%ADMIN%' OR SapCode LIKE '%PARTNER%' OR SapCode LIKE '%MANAGER%' OR SapCode LIKE '%EMP%')
ORDER BY 
    CASE 
        WHEN SapCode LIKE '%ADMIN%' THEN 1
        WHEN SapCode LIKE '%PARTNER%' THEN 2
        WHEN SapCode LIKE '%MANAGER%' THEN 3
        ELSE 4
    END;

PRINT '';
PRINT '=====================================================';
PRINT 'PROJECT ASSIGNMENTS (for RBAC testing)';
PRINT '=====================================================';

SELECT 
    p.Name AS ProjectName,
    p.Wbs,
    r.FullNameEn AS AssignedUser,
    r.SapCode,
    CASE 
        WHEN r.SapCode LIKE '%ADMIN%' THEN 'Admin [FUTURE]'
        WHEN r.SapCode LIKE '%PARTNER%' THEN 'Partner [FUTURE]'
        WHEN r.SapCode LIKE '%MANAGER%' THEN 'Manager [FUTURE]'
        ELSE 'Employee [FUTURE]'
    END AS PlannedRole
FROM Project p
JOIN ForecastVersion fv ON p.Id = fv.ProjectId
JOIN ResourceAllocation ra ON fv.Id = ra.ForecastVersionId
JOIN Roster r ON ra.RosterId = r.Id
WHERE p.Wbs LIKE 'TEST.%'
GROUP BY p.Name, p.Wbs, r.FullNameEn, r.SapCode
ORDER BY p.Name, r.FullNameEn;

PRINT '';
PRINT 'Script completed successfully!';
PRINT '=====================================================';
PRINT 'NEXT STEPS:';
PRINT '1. Run SnapshotRecalculationService to generate snapshot data';
PRINT '2. Open TEST_Snapshot Workflow Project in UI';
PRINT '3. Verify January month is Editable (green)';
PRINT '4. Execute Epic 8 test cases';
PRINT '=====================================================';
